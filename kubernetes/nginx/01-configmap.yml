apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-global-config
data:
  nginx.conf: |
    user nginx;
    pid /var/run/nginx.pid;
    worker_processes auto;
    worker_rlimit_nofile 65535;

    events {
      multi_accept on;
      worker_connections 65535;
    }

    http {
      # How long to allow each connection to stay idle; longer values are better
      # for each individual client, particularly for SSL, but means that worker
      # connections are tied up longer. (Default: 65)
      keepalive_timeout 20;

      # Speed up file transfers by using sendfile() to copy directly
      # between descriptors rather than using read()/write().
      sendfile on;

      # Tell Nginx not to send out partial frames; this increases throughput
      # since TCP frames are filled up before being sent out. (adds TCP_CORK)
      tcp_nopush on;

      # Tell Nginx to enable the Nagle buffering algorithm for TCP packets, which
      # collates several smaller packets together into one larger packet, thus saving
      # bandwidth at the cost of a nearly imperceptible increase to latency. (removes TCP_NODELAY)
      tcp_nodelay off;

      # Define the MIME types for files.
      include /etc/nginx/mime.types;
      default_type application/octet-stream;

      access_log /dev/stdout;
      error_log /dev/stderr warn;

      server_tokens off;

      real_ip_header X-Forwarded-For;
      real_ip_recursive on;

      set_real_ip_from 10.0.0.0/8;

      include /etc/nginx/conf.d/*.conf;
    }
  cloud-wp.conf: |
    server {
      listen 80 default;
      server_name test.skates.guru;
      root /usr/share/nginx/html;

      location ~ /\.(?!well-known) {
        deny all;
      }

      rewrite ^([^.]*[^/])$ $1/ permanent;

      if ($my_blog_post_id != "") {
        rewrite ^(.*)$ https://test.skates.guru/$my_blog_post_id permanent;
      }

      rewrite ^/wordpress/?(.*)$ https://test.skates.guru/$1 permanent;

      location / {
        index index.html index.htm;
      }
    }
